<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Avatar Customizer ‚Äî Robust Import + CDN Scan + Exports</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif;color:#e8ecf1;background:#0b0d12}
#app{height:100%;display:grid;grid-template-rows:48px 1fr 30px}
:root{--rightW:560px; --leftW:230px; --leftWCollapsed:48px}

/* TOP */
.topbar{display:flex;align-items:center;justify-content:space-between;height:48px;padding:0 10px;background:#0d1220;border-bottom:1px solid #1d2538}
.title{display:flex;gap:10px;align-items:center}
.title h1{margin:0;font-size:1rem;line-height:1}
.title .meta{font-size:.8rem;color:#95a0b3}
.actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.btn{background:#18223a;border:1px solid #243152;color:#e8ecf1;border-radius:8px;padding:6px 10px;font-size:.85rem;cursor:pointer}
.btn:disabled{opacity:.5;cursor:default}
select{background:#0f1424;color:#e8ecf1;border:1px solid #243152;border-radius:8px;padding:6px 10px}
input[type="file"]{display:none}
.pill{font-size:.78rem;color:#9ac3ff}
.pill.warn{color:#ffb4b4}

/* BODY */
.body{height:100%;display:grid;grid-template-columns:var(--leftW) 1fr 6px var(--rightW);gap:8px;padding:8px;min-height:0}
.body.collapsed{grid-template-columns:var(--leftWCollapsed) 1fr 6px var(--rightW)}

/* LEFT */
.left{background:#121621;border:1px solid #1d2538;border-radius:12px;display:flex;flex-direction:column;overflow:hidden;min-height:0}
.leftHead{display:flex;align-items:center;justify-content:flex-end;padding:8px;border-bottom:1px solid #1d2538}
.tablist{list-style:none;margin:0;padding:6px;display:flex;flex-direction:column;gap:6px}
.tab{display:grid;grid-template-columns:1fr auto;align-items:center;gap:6px;padding:8px;border:1px solid #243152;border-radius:10px;background:#0f1424;cursor:pointer}
.tab .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tab .iconPart{display:none}
.rowbtns{display:flex;gap:6px}
.icon{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#18223a;border:1px solid #243152;cursor:pointer}
.icon:hover{outline:2px solid #394b79}
.collapsed .rowbtns{display:none}
.collapsed .tab{grid-template-columns:1fr}
.collapsed .name{display:none}
.collapsed .tab .iconPart{display:block;text-align:center;font-size:14px}
.collapsed .leftHead{justify-content:center}
#toggleLeft{font-size:10px;padding:2px 4px}

/* MID */
.mid{background:#121621;border:1px solid #1d2538;border-radius:12px;display:grid;grid-template-rows:auto 1fr;min-height:0}
.colors{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px;border-bottom:1px solid #1d2538}
.swatch{width:20px;height:20px;border-radius:999px;border:2px solid #0b0d12;cursor:pointer;outline:1px solid #2a3558}
.swatch.active{outline:2px solid #6ee7ff}
.grid{padding:10px;overflow:auto;display:grid;grid-template-columns:repeat(auto-fill, minmax(90px,1fr));gap:10px;min-height:0;place-content:start;grid-auto-rows:106px}
.cell{height:106px;background:#0e1426;border:1px solid #2a385e;border-radius:10px;display:grid;grid-template-rows:1fr auto;cursor:pointer;position:relative}
.cell .thumb{display:grid;place-items:center}
.cell .thumb img{width:84px;height:84px;image-rendering:pixelated}
.cell .label{font-size:.8rem;color:#cbd4e6;text-align:center;padding:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cell.active{box-shadow:0 0 0 2px #6ee7ff inset}
.cell.selected{outline:2px solid #6ee7ff}
.badge{position:absolute;top:6px;left:6px;font-size:.7rem;background:#2d3748;color:#e2e8f0;border:1px solid #4a5568;padding:1px 6px;border-radius:999px}
.cell.add{border:1px dashed #2a385e;background:#0b0f1f;place-items:center}
.cell.add .plus{font-size:28px;line-height:1;color:#9ab3ff}
.cell.add .label{color:#9ab3ff}

/* SPLITTER */
.split{background:#1d2538;border-radius:6px;cursor:col-resize}
.split:hover{background:#2a3656}

/* RIGHT */
.right{background:#121621;border:1px solid #1d2538;border-radius:12px;display:grid;grid-template-rows:1fr;min-width:360px;min-height:0}
.stage{display:grid;grid-template-rows:auto 1fr;min-height:0}
.framebar{display:flex;flex-direction:column;gap:6px;padding:8px;border-bottom:1px solid #1d2538;background:#10182a;overflow-x:auto}
.framebar-top{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;row-gap:8px}
.zoom-controls,.export-controls,.scan-controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.view{display:grid;place-items:center;padding:8px;min-height:0}
.canvasWrap{display:block;overflow:auto;border-radius:12px;border:1px solid #203055;max-width:100%;max-height:100%;width:100%;height:100%;background:#0b0d12;cursor:default;position:relative}
#sheet{image-rendering:pixelated;display:block}
#frameLabel{margin-left:8px;padding:2px 8px;border-radius:12px;background:#223;color:#cfe;font-size:12px}
.zoom-controls-overlay .btn{padding:2px 6px;font-size:11px;min-width:24px;height:24px}

/* BG bottom-left */
.bg-color-overlay{position:absolute;bottom:8px;left:8px;background:rgba(16,24,42,0.9);padding:4px 6px;border-radius:6px;border:1px solid #243152;display:flex;gap:6px;align-items:center}
.bg-color-overlay label{font-size:12px;color:#e8ecf1;cursor:pointer}
.bg-color-overlay input[type="color"]{width:24px;height:24px;padding:0;border:none;cursor:pointer;background:none}

/* FOOTER */
.status{display:flex;gap:8px;align-items:center;background:#0d1220;border-top:1px solid #1d2538;padding:4px 8px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.82rem;color:#bcd0ff;background:#0f1424;border:1px solid #243152;border-radius:8px;padding:3px 8px;flex:1;overflow:auto;white-space:nowrap}
.left-group{display:flex;gap:6px;align-items:center}

/* scrollbars */
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-track{background:#0e1426;border-radius:8px}
::-webkit-scrollbar-thumb{background:#394b79;border-radius:8px;border:2px solid #0e1426}
::-webkit-scrollbar-thumb:hover{background:#4ea1ff}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="title">
      <h1>Avatar Customizer</h1>
      <div class="meta">432√ó256 sheet ¬∑ Face/Skin/Hair/Clothes/Glass</div>
    </div>
    <div class="actions">
      <span class="pill" id="perf">Idle</span>
      <span class="pill warn" id="corsState" title="Ïô∏Î∂Ä Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑûÏù¥Î©¥ Ï†ÄÏû•/ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ï†úÌïú">export: ok</span>
      <label class="btn" for="inZip">Open ZIP</label><input id="inZip" type="file" accept="application/zip">
      <label class="btn" for="inDir">Open Folder</label><input id="inDir" type="file" webkitdirectory directory multiple accept="image/*">
      <input id="inFiles" type="file" accept="image/*" multiple style="display:none">
      <button class="btn" id="cdnScan" type="button">CDN Auto-Scan</button>
      <button class="btn" id="allRand" type="button" disabled>Ï†ÑÏ≤¥ ÎûúÎç§</button>
    </div>
  </div>

  <div id="bodyGrid" class="body">
    <aside id="leftPanel" class="left">
      <div class="leftHead">
        <button id="toggleLeft" class="btn" type="button" title="Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞">‚óÄ</button>
      </div>
      <div class="tablist" id="tablist"></div>
    </aside>

    <section class="mid">
      <div class="colors" id="colorBar"></div>
      <div class="grid" id="grid"></div>
    </section>

    <div class="split" id="split"></div>

    <aside class="right">
      <div class="stage">
        <div class="framebar">
          <div class="framebar-top">
            <div class="left-group">
              <span class="pill">ÌîÑÎ†àÏûÑ <span id="frameLabel">-</span></span>
            </div>
            <div class="scan-controls">
              <label>part</label>
              <select id="scanPart">
                <option value="face">face</option>
                <option value="skin">skin</option>
                <option value="hair">hair</option>
                <option value="clothes">clothes</option>
                <option value="glass">glass</option>
              </select>
              <button class="btn" id="scanGo" title="Îπ†Î•∏ Ïä§Ï∫î ÏãúÏûë">Scan</button>
            </div>
            <div class="zoom-controls">
              <button class="btn" id="zoomInOverlay" title="ÌôïÎåÄ">Ôºã</button>
              <button class="btn" id="zoomFitOverlay" title="ÌôîÎ©¥Ïóê ÎßûÏ∂§">Fit</button>
            </div>
            <div class="export-controls">
              <select id="exportScale" title="Ï†ÄÏû• Î∞∞Ïú®" style="margin-right:6px;">
                <option value="1" selected>1x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
                <option value="6">6x</option>
                <option value="8">8x</option>
              </select>
              <button class="btn" id="saveWebp" title="ÌòÑÏû¨ ÏãúÌä∏ Ï†ÑÏ≤¥ Ï†ÄÏû•">Sheet</button>
              <button class="btn" id="saveSelected" title="ÏÑ†ÌÉù ÌîÑÎ†àÏûÑÎì§ 1ÌååÏùº">Selected</button>
              <button class="btn" id="saveAllZip" title="Î™®Îì† ÌîÑÎ†àÏûÑ(36) ZIP">All</button>
              <button class="btn" id="exportFrames" title="ÏÑ†ÌÉù ÌîÑÎ†àÏûÑ Í∞ÅÍ∞Å Ï†ÄÏû•">Frames</button>
            </div>
          </div>
        </div>
        <div class="view">
          <div class="canvasWrap" id="canvasWrap">
            <canvas id="sheet" width="432" height="256"></canvas>
            <div class="bg-color-overlay">
              <label for="bgColor">BG</label>
              <input id="bgColor" type="color" value="#0b0d12">
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="status">
    <div id="selText" class="mono">face: -, skin: -, hair: -, clothes: -</div>
    <button class="btn" id="copySel" type="button">Copy</button>
  </div>
</div>

<script>
(function(){
  /* ===== constants/state ===== */
  const ORDER = ['skin','clothes','face','hair','glass'];
  const PART_LABEL = {face:'ÏñºÍµ¥', skin:'ÌîºÎ∂Ä', hair:'Ìó§Ïñ¥', clothes:'ÏùòÏÉÅ', glass:'ÏïàÍ≤Ω'};
  const PART_ICON  = {face:'üôÇ', skin:'üß¥', hair:'‚úÇÔ∏è', clothes:'üëï', glass:'üëì'};
  const PARTS = ['face','skin','hair','clothes','glass'];
  const COLORABLE = new Set(['hair','clothes']);
  const COLOR_HEX = ['#111111','#8b8b99','#e58a2b','#f2c94c','#3772ff','#7ed0ff','#8b5e34','#9b59b6','#ff66b3','#eaeaea','#ff3b30','#2ecc71'];
  const BALD_MIN=-144, BALD_MAX=-133;
  const ZEP_BASE='https://cdn-static.zep.us/static/assets/sprites';

  const perf = document.getElementById('perf');
  const corsState = document.getElementById('corsState');
  const bgColor = document.getElementById('bgColor');
  const inZip = document.getElementById('inZip');
  const inDir = document.getElementById('inDir');
  const inFiles = document.getElementById('inFiles');
  const cdnScanBtn = document.getElementById('cdnScan');
  const scanPartSel = document.getElementById('scanPart');
  const scanGoBtn = document.getElementById('scanGo');
  const allRand = document.getElementById('allRand');
  const bodyGrid = document.getElementById('bodyGrid');
  const leftPanel = document.getElementById('leftPanel');
  const toggleLeft = document.getElementById('toggleLeft');
  const tablist = document.getElementById('tablist');
  const grid = document.getElementById('grid');
  const colorBar = document.getElementById('colorBar');
  const canvasWrap = document.getElementById('canvasWrap');
  const cvs = document.getElementById('sheet');
  const ctx = cvs.getContext('2d', {alpha:true}); ctx.imageSmoothingEnabled=false;
  const selText = document.getElementById('selText');
  const copySel = document.getElementById('copySel');
  const zoomInBtn = document.getElementById('zoomInOverlay');
  const zoomFitBtn = document.getElementById('zoomFitOverlay');
  const frameLabel = document.getElementById('frameLabel');
  const saveWebpBtn = document.getElementById('saveWebp');
  const saveSelectedBtn = document.getElementById('saveSelected');
  const saveAllZipBtn = document.getElementById('saveAllZip');
  const exportFramesBtn = document.getElementById('exportFrames');

  const selectionState = { selected:new Set(), hover:-1 };

  const store = window.store = {
    assets:{ face:new Map(), skin:new Map(), hair:new Map(), clothes:new Map(), glass:new Map() },
    selPart:'face',
    color:0,
    pick:{ face:null, skin:null, hair:null, clothes:null, glass:null },
    selectedShapes: new Set(),
    _visibleShapes: [],
    _anchorShape: null
  };

  function isExternalUrl(u){
    try{
      if (!u) return false;
      if (u.startsWith('blob:') || u.startsWith('data:')) return false;
      const a = new URL(u, location.href);
      return a.origin !== location.origin;
    }catch{ return false; }
  }
  function refreshExportLock(){
    let locked=false;
    for(const p of PARTS){
      for(const v of store.assets[p].values()){
        if (v && v.url && isExternalUrl(v.url)) { locked=true; break; }
      }
      if(locked) break;
    }
    corsState.textContent = locked ? 'export: CORS-locked' : 'export: ok';
    corsState.title = locked ? 'Ïô∏Î∂Ä(CDN) Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑûÏûÑ ‚Äî Îã§Ïö¥Î°úÎìúÍ∞Ä Ï∞®Îã®Îê† Ïàò ÏûàÏùå (ZIP/Ìè¥ÎçîÎ°ú Î∂àÎü¨Ïò§Î©¥ Ìï¥Í≤∞)' : 'ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Í∞ÄÎä•';
    saveWebpBtn.disabled = locked;
    saveSelectedBtn.disabled = locked;
    saveAllZipBtn.disabled = locked;
    exportFramesBtn.disabled = locked;
  }

  /* ===== helpers ===== */
  function colorIdxFromShape(shape){ return ((-shape - 1) % 12 + 12) % 12; }
  function blockFromShape(shape){ return Math.floor(((-shape - 1) / 12)); }
  function shapeFromBlockColor(block, colorIdx){ return -(block*12 + colorIdx + 1); }
  function isBaldShape(shape){ return shape>=BALD_MIN && shape<=BALD_MAX; }
  function updateAllRandEnabled(){ const total = PARTS.reduce((a,p)=>a+store.assets[p].size,0); allRand.disabled = (total===0); }
  function loadImage(url){ return new Promise((res)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>res(im); im.onerror=()=>res(null); im.src=url; }); }
  async function ensureBitmap(obj){ if(!obj || !obj.url) return null; if(obj.img) return obj.img; obj.img = await loadImage(obj.url); return obj.img; }

  /* ===== robust part detection ===== */
  const PART_RE = /(face|skin|hair|clothes|glass)/i;
  function detectPartFromPath(fullPath){
    const low=(fullPath||'').toLowerCase().replace(/\\/g,'/');
    const segs = low.split('/').filter(Boolean);
    for(const s of segs){ const m = s.match(PART_RE); if (m) return m[1]; }
    const fname = segs[segs.length-1] || '';
    const m2 = fname.match(/^(\w+)[-_]/);
    if(m2 && PARTS.includes(m2[1])) return m2[1];
    return null;
  }
  function detectShapeFromName(name){ const m=(name||'').match(/(-?\d+)/); return m?parseInt(m[1],10):null; }
  function isPreviewName(name){ return /preview/i.test(name||''); }

  /* ===== tabs ===== */
  function activateTab(p){ tablist.querySelectorAll('.tab').forEach(el=>{ el.style.outline=(el.dataset.part===p)?'2px solid #6ee7ff':'none'; }); }
  PARTS.forEach(p=>{
    const tab=document.createElement('div'); tab.className='tab'; tab.dataset.part=p;
    const name=document.createElement('div'); name.className='name'; name.textContent=PART_LABEL[p];
    const icoPart=document.createElement('div'); icoPart.className='iconPart'; icoPart.textContent=PART_ICON[p];
    const btns=document.createElement('div'); btns.className='rowbtns';
    const icoRandFree=document.createElement('div'); icoRandFree.className='icon'; icoRandFree.title='ÎûúÎç§+ÏÉâ'; icoRandFree.textContent='üé≤';
    const icoRandLock=document.createElement('div'); icoRandLock.className='icon'; icoRandLock.title='ÎûúÎç§(ÏÉâ Í≥†Ï†ï)'; icoRandLock.textContent='üîí';
    const icoReset=document.createElement('div'); icoReset.className='icon'; icoReset.title='Ï¥àÍ∏∞Ìôî'; icoReset.textContent='‚Ü∫';
    icoRandFree.addEventListener('click',(e)=>{ e.stopPropagation(); randomCategory(p,true); });
    icoRandLock.addEventListener('click',(e)=>{ e.stopPropagation(); randomCategory(p,false); });
    icoReset.addEventListener('click',(e)=>{ e.stopPropagation(); resetCategory(p); });
    btns.append(icoRandFree,icoRandLock,icoReset);
    tab.append(name,icoPart,btns);
    tab.addEventListener('click',(e)=>{ if(e.target.closest('.rowbtns')) return; selectPart(p); });
    tablist.appendChild(tab);
  });

  /* ===== colors ===== */
  const colorDots=[];
  COLOR_HEX.forEach((hex,i)=>{
    const d=document.createElement('div'); d.className='swatch'; d.style.background=hex; d.dataset.idx=i;
    d.addEventListener('click',()=>onColorClick(i));
    colorBar.appendChild(d); colorDots.push(d);
  });
  function highlightColor(){ colorDots.forEach((el,i)=> el.classList.toggle('active', i===store.color)); }

  /* ===== grid ===== */
  function clearGridSelection(){ store.selectedShapes.clear(); document.querySelectorAll('.cell.selected').forEach(c=>c.classList.remove('selected')); store._anchorShape=null; }
  function buildGrid(){
    const p=store.selPart, map=store.assets[p]; store._visibleShapes=[]; grid.innerHTML='';
    const addCell=document.createElement('div'); addCell.className='cell add'; addCell.title='ÌòÑÏû¨ ÌååÌä∏Î°ú Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä';
    const th=document.createElement('div'); th.className='thumb'; const plus=document.createElement('div'); plus.className='plus'; plus.textContent='Ôºã'; th.appendChild(plus);
    const lb=document.createElement('div'); lb.className='label'; lb.textContent='Add';
    addCell.append(th,lb); addCell.addEventListener('click',()=>{ inFiles && inFiles.click(); }); grid.appendChild(addCell);
    const filter = COLORABLE.has(p) ? store.color : null;
    const shapes=[...map.keys()].sort((a,b)=>a-b); const frag=document.createDocumentFragment();
    for(const shape of shapes){
      if(filter!=null && colorIdxFromShape(shape)!==filter) continue;
      store._visibleShapes.push(shape);
      const item = map.get(shape);
      const d=document.createElement('div'); d.className='cell'; d.dataset.shape=shape;
      const th=document.createElement('div'); th.className='thumb';
      const img=new Image(); img.width=84; img.height=84; img.src=item.previewUrl || item.url; img.style.imageRendering='pixelated'; th.appendChild(img);
      const lb=document.createElement('div'); lb.className='label'; lb.textContent=`#${shape}`; lb.title=item.name||`#${shape}`;
      d.append(th,lb);
      if(p==='hair' && isBaldShape(shape)){ const badge=document.createElement('div'); badge.className='badge'; badge.textContent='Îπà'; d.appendChild(badge); }
      if(store.pick[p]===shape) d.classList.add('active');
      if (store.selectedShapes.size && store.selectedShapes.has(shape)) d.classList.add('selected');
      d.addEventListener('click', async (e)=>{
        if (e.ctrlKey || e.metaKey) { d.classList.toggle('selected'); if (d.classList.contains('selected')) store.selectedShapes.add(shape); else store.selectedShapes.delete(shape); store._anchorShape=shape; return; }
        if (e.shiftKey){
          const vis = store._visibleShapes||[]; const anchor = store._anchorShape!=null?store._anchorShape:shape;
          const ai=vis.indexOf(anchor), bi=vis.indexOf(shape);
          if (ai!==-1 && bi!==-1){
            const [s,eidx]= ai<=bi ? [ai,bi] : [bi,ai]; store.selectedShapes.clear();
            document.querySelectorAll('.cell.selected').forEach(c=>c.classList.remove('selected'));
            for(let k=s;k<=eidx;k++){ const sh=vis[k]; store.selectedShapes.add(sh); }
            document.querySelectorAll('.cell').forEach(c=>{ if(c.classList.contains('add')) return; const sh=parseInt(c.dataset.shape,10); if(store.selectedShapes.has(sh)) c.classList.add('selected'); });
          }
          return;
        }
        clearGridSelection(); store.pick[p]=shape; store._anchorShape=shape; buildGrid(); await drawSheet(); updateSelText();
      });
      frag.appendChild(d);
    }
    grid.appendChild(frag);
    updateSelText(); updateAllRandEnabled(); refreshExportLock();
  }

  /* ===== draw ===== */
  async function drawSheet(){
    ctx.clearRect(0,0,432,256);
    for(const part of ORDER){
      const shape = store.pick[part];
      const map = store.assets[part];
      if(shape==null || !map || !map.has(shape)) continue;
      const obj = map.get(shape); if(!obj || !obj.url) continue;
      const img = await ensureBitmap(obj); if (img) ctx.drawImage(img,0,0);
    }
  }

  /* ===== color/select ===== */
  function onColorClick(ci){
    const p=store.selPart;
    if(COLORABLE.has(p) && store.pick[p]!=null){
      const block = blockFromShape(store.pick[p]);
      const target = shapeFromBlockColor(block, ci);
      if(store.assets[p].has(target)) store.pick[p]=target;
    }
    store.color=ci; highlightColor(); buildGrid(); drawSheet();
  }
  function selectPart(p){
    store.selPart=p; activateTab(p);
    colorBar.style.display = COLORABLE.has(p)?'flex':'none';
    highlightColor(); buildGrid();
  }

  /* ===== export helpers ===== */
  window.fileBase = function fileBase(){
    const t = selText.textContent || '';
    const face = t.match(/face:\\s*([\\-\\d]+)/i);
    const skin = t.match(/skin:\\s*([\\-\\d]+)/i);
    const hair = t.match(/hair:\\s*([\\-\\d]+)/i);
    const clothes = t.match(/clothes:\\s*([\\-\\d]+)/i);
    if (face && skin && hair && clothes) return `${face[1]},${skin[1]},${hair[1]},${clothes[1]}`;
    return 'sheet';
  };
  window.__getExportScale = function(){ const el=document.getElementById('exportScale'); let s=el?parseFloat(el.value||'1'):1; if(!Number.isFinite(s)||s<=0) s=1; return Math.min(16,Math.max(1,s)); };
  async function encodeWebPFromCanvas(canvas, {lossless=true, quality=1.0}={}){
    return await new Promise(res=> canvas.toBlob(res, 'image/webp', quality));
  }

  function updateSelText(){ const t=`face: ${store.pick.face ?? '-'}, skin: ${store.pick.skin ?? '-'}, hair: ${store.pick.hair ?? '-'}, clothes: ${store.pick.clothes ?? '-'}`; selText.textContent=t; }
  copySel.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(selText.textContent); copySel.textContent='Copied'; setTimeout(()=>copySel.textContent='Copy',1000);}catch{ alert('ÌÅ¥Î¶ΩÎ≥¥Îìú Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§'); }});

  /* ===== random/reset ===== */
  function randomCategory(p, withColor){
    const map=store.assets[p]; const keys=[...map.keys()]; if(!keys.length) return;
    if(COLORABLE.has(p)){
      if(withColor){ store.pick[p]=keys[Math.floor(Math.random()*keys.length)]; if(store.selPart===p){ store.color=colorIdxFromShape(store.pick[p]); highlightColor(); } }
      else{ const bucket=store.color; const cand=keys.filter(s=>colorIdxFromShape(s)===bucket); store.pick[p]=(cand.length?cand:keys)[Math.floor(Math.random()* (cand.length?cand.length:keys.length))]; }
    }else{ store.pick[p]=keys[Math.floor(Math.random()*keys.length)]; }
    buildGrid(); drawSheet();
  }
  function resetCategory(p){ store.pick[p]=null; buildGrid(); drawSheet(); }
  allRand.addEventListener('click',()=>{ ['face','skin','hair','clothes'].forEach(p=>randomCategory(p,true)); });

  /* ===== file inputs (robust) ===== */
  async function addFilesFromList(fileList, targetPart){
    const files=Array.from(fileList||[]); if(!files.length) return;
    const groups=new Map();
    for(const f of files){
      const rel=f.webkitRelativePath||f.name;
      let part = detectPartFromPath(rel);
      if(!part && targetPart) part = targetPart;
      if(!part){ // if still unknown, try by filename prefix fallback
        const base=(rel.split('/').pop()||'').toLowerCase();
        const m = base.match(PART_RE); if(m) part = m[1];
      }
      if(!part) continue;
      if(!groups.has(part)) groups.set(part,[]);
      groups.get(part).push(f);
    }
    for(const [part,arr] of groups){
      const map=store.assets[part];
      for(const f of arr){
        const shape=detectShapeFromName(f.name); if(shape==null) continue;
        const url=URL.createObjectURL(f);
        let cell=map.get(shape); if(!cell){ cell={url:null,previewUrl:null,name:f.name}; map.set(shape,cell); }
        if(isPreviewName(f.name)) cell.previewUrl=url; else cell.url=url;
        if(!cell.previewUrl) cell.previewUrl=cell.url; cell.name=f.name;
      }
    }
    ['face','skin','hair','clothes','glass'].forEach(p=>{ if(store.pick[p]!=null) return; const m=store.assets[p]; const keys=[...m.keys()].sort((a,b)=>a-b); if(m.has(-1)) store.pick[p]=-1; else if(keys.length) store.pick[p]=keys[0]; });
    if(store.pick.hair!=null) store.color=colorIdxFromShape(store.pick.hair); else if(store.pick.clothes!=null) store.color=colorIdxFromShape(store.pick.clothes);
    selectPart(store.selPart||'face'); await drawSheet(); updateAllRandEnabled(); refreshExportLock();
  }
  inDir && inDir.addEventListener('change',async (e)=>{ await addFilesFromList(e.target.files); e.target.value=''; });
  inFiles && inFiles.addEventListener('change',async (e)=>{ await addFilesFromList(e.target.files, store.selPart||'face'); e.target.value=''; });
  inZip && inZip.addEventListener('change',async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    const buf=await file.arrayBuffer(); const zip=await JSZip.loadAsync(buf);
    const entries=[]; zip.forEach((path,en)=>{ if(en.dir) return; const low=path.toLowerCase(); if(!/\\.(png|webp|jpe?g)$/.test(low)) return; entries.push(en); });
    entries.sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true}));
    for(const en of entries){
      const path=en.name.replace(/\\\\/g,'/');
      let part = detectPartFromPath(path);
      if(!part) continue; // require a part somewhere in path or filename
      const base = path.split('/').pop()||'';
      const isPrev = /preview/i.test(base);
      const m = base.match(/(-?\\d+)/); if(!m) continue;
      const shape = parseInt(m[1],10);
      const blob = await en.async('blob');
      const url = URL.createObjectURL(blob);
      const map = store.assets[part];
      if(!map.has(shape)) map.set(shape,{url:null,previewUrl:null,name:base});
      const cell = map.get(shape);
      if(isPrev) cell.previewUrl=url; else cell.url=url;
      if(!cell.previewUrl) cell.previewUrl=cell.url;
      if(!cell.name) cell.name=base;
    }
    e.target.value='';
    ['face','skin','hair','clothes','glass'].forEach(p=>{ const map=store.assets[p]; if(!map||map.size===0) return; if(store.pick[p]==null){ const keys=[...map.keys()].sort((a,b)=>a-b); store.pick[p]=map.has(-1)?-1:(keys[0]??null);} });
    if(store.pick.hair!=null) store.color=colorIdxFromShape(store.pick.hair); else if(store.pick.clothes!=null) store.color=colorIdxFromShape(store.pick.clothes);
    selectPart('face'); await drawSheet(); updateAllRandEnabled(); refreshExportLock();
  });

  /* ===== preview overlay (selection) ===== */
  (function initOverlay(){
    const wrap=document.getElementById('canvasWrap');
    let overlay=document.getElementById('sheetOverlay');
    if(!overlay){ overlay=document.createElement('canvas'); overlay.id='sheetOverlay'; overlay.width=432; overlay.height=256; overlay.style.position='absolute'; overlay.style.inset='0'; overlay.style.pointerEvents='none'; overlay.style.imageRendering='pixelated'; wrap.style.position='relative'; cvs.style.position='relative'; wrap.appendChild(overlay); }
    const octx=overlay.getContext('2d',{alpha:true});
    const state = { anchor:null, selected:new Set(), hover:-1, dragging:false, dragStart:null, dragEnd:null, dirty:true };
    window.__FRAME_SELECT__ = state;

    function compressRanges(arr){
      if(arr.length===0) return '-'; arr.sort((a,b)=>a-b); let ranges=[], s=arr[0], prev=arr[0];
      for(let i=1;i<arr.length;i++){ const n=arr[i]; if(n===prev+1){ prev=n; continue; } ranges.push(s===prev?`${s}`:`${s}~${prev}`); s=prev=n; }
      ranges.push(s===prev?`${s}`:`${s}~${prev}`); return ranges.join(',');
    }
    function frameAtEvent(e){
      const rect=cvs.getBoundingClientRect();
      const sx=(e.clientX-rect.left)*(cvs.width/rect.width);
      const sy=(e.clientY-rect.top)*(cvs.height/rect.height);
      if(sx<0||sy<0||sx>=cvs.width||sy>=cvs.height) return -1;
      const c=Math.floor(sx/48), r=Math.floor(sy/64); const idx=r*9+c; return (idx>=0&&idx<36)?idx:-1;
    }
    function rectOfIndex(i){ const c=i%9, r=Math.floor(i/9); return {x:c*48, y:r*64, w:48, h:64}; }
    function indexInRect(i,R){ const a=rectOfIndex(i); return !(a.x+a.w<=R.x || a.y+a.h<=R.y || a.x>=R.x+R.w || a.y>=R.y+R.h); }
    function drawOverlay(){
      if(!state.dirty) return; state.dirty=false;
      const r=cvs.getBoundingClientRect(); overlay.style.width=Math.round(r.width)+'px'; overlay.style.height=Math.round(r.height)+'px';
      octx.clearRect(0,0,overlay.width,overlay.height);
      if(state.hover>=0){ const c=state.hover%9, r=Math.floor(state.hover/9); octx.save(); octx.strokeStyle='#ffffffb3'; octx.lineWidth=2; octx.strokeRect(c*48+1,r*64+1,46,62); octx.restore(); }
      if (state.dragging && state.dragStart!=null && state.dragEnd!=null){
        const A=rectOfIndex(state.dragStart), B=rectOfIndex(state.dragEnd);
        const R={x:Math.min(A.x,B.x), y:Math.min(A.y,B.y), w:Math.abs(A.x-B.x)+48, h:Math.abs(A.y-B.y)+64};
        octx.save(); octx.strokeStyle='#70b2ff'; octx.setLineDash([4,3]); octx.strokeRect(R.x+0.5,R.y+0.5,R.w-1,R.h-1); octx.restore();
      }
      state.selected.forEach(i=>{ const c=i%9, r=Math.floor(i/9); octx.save(); octx.strokeStyle='#4ea1ff'; octx.lineWidth=2; octx.strokeRect(c*48+1,r*64+1,46,62); octx.restore(); });
      frameLabel.textContent = state.selected.size? compressRanges([...state.selected]) : (state.hover>=0? state.hover:'-');
      selectionState.selected = new Set(state.selected); selectionState.hover=state.hover;
    }
    function loop(){ drawOverlay(); requestAnimationFrame(loop); } requestAnimationFrame(loop);

    cvs.addEventListener('mousemove',(e)=>{ const idx=frameAtEvent(e); state.hover=idx; if(state.dragging){ state.dragEnd=(idx<0?state.dragEnd:idx);} state.dirty=true; });
    cvs.addEventListener('mouseleave',()=>{ state.hover=-1; state.dirty=true; });
    cvs.addEventListener('mousedown',(e)=>{ if(e.button!==0) return; const idx=frameAtEvent(e); if(idx<0) return; state.dragging=true; state.dragStart=idx; state.dragEnd=idx; state.dirty=true; });
    window.addEventListener('mouseup',(e)=>{
      if(!state.dragging) return; state.dragging=false; const a=state.dragStart, b=state.dragEnd;
      if(a!=null && b!=null){ const A=rectOfIndex(a), B=rectOfIndex(b); const R={x:Math.min(A.x,B.x), y:Math.min(A.y,B.y), w:Math.abs(A.x-B.x)+48, h:Math.abs(A.y-B.y)+64};
        let set=new Set(); for(let i=0;i<36;i++) if(indexInRect(i,R)) set.add(i);
        if(e.ctrlKey||e.metaKey){ set.forEach(i=>{ if(state.selected.has(i)) state.selected.delete(i); else state.selected.add(i); }); }
        else { state.selected=set; }
        state.anchor=b;
      }
      state.dragStart=null; state.dragEnd=null; state.dirty=true;
    }, {capture:true});

    cvs.addEventListener('click',(e)=>{
      const rect=cvs.getBoundingClientRect();
      if(e.clientX<rect.left||e.clientX>rect.right||e.clientY<rect.top||e.clientY>rect.bottom) return;
      const sx=(e.clientX-rect.left)*(cvs.width/rect.width), sy=(e.clientY-rect.top)*(cvs.height/rect.height);
      const c=Math.floor(sx/48), r=Math.floor(sy/64); const idx=r*9+c; if(idx<0||idx>=36) return;
      if(e.shiftKey){ if(state.anchor==null) state.anchor=idx; const a=Math.min(state.anchor,idx), b=Math.max(state.anchor,idx);
        if(e.ctrlKey||e.metaKey){ for(let i=a;i<=b;i++){ if(state.selected.has(i)) state.selected.delete(i); else state.selected.add(i); } }
        else { state.selected=new Set(Array.from({length:b-a+1},(_,k)=>a+k)); }
      } else if(e.ctrlKey||e.metaKey){ if(state.selected.has(idx)) state.selected.delete(idx); else state.selected.add(idx); state.anchor=idx; }
      else { state.selected=new Set([idx]); state.anchor=idx; }
      state.dirty=true;
    });

    document.addEventListener('keydown',(e)=>{
      const tag=(e.target && e.target.tagName)? e.target.tagName.toUpperCase():'';
      if(tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT'||(e.target&&e.target.isContentEditable)) return;
      if((e.ctrlKey||e.metaKey) && (e.key==='a'||e.key==='A')){ e.preventDefault(); state.selected=new Set(Array.from({length:36},(_,i)=>i)); state.dirty=true; }
    });

    cvs.addEventListener('contextmenu', async (e)=>{
      if (state.selected.size===0) return;
      e.preventDefault();
      const list=[...state.selected].sort((a,b)=>a-b);
      const oc=document.createElement('canvas'); oc.width=48*list.length; oc.height=64; const g=oc.getContext('2d'); g.imageSmoothingEnabled=false;
      list.forEach((i,k)=>{ const sx=(i%9)*48, sy=Math.floor(i/9)*64; g.drawImage(cvs,sx,sy,48,64,48*k,0,48,64); });
      try{ const blob=await new Promise(res=>oc.toBlob(res,'image/png')); await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);
        const old=perf.textContent; perf.textContent=`‚úÖ Copied ${list.length} frames`; perf.style.color='#2ecc71'; perf.style.fontWeight='bold'; setTimeout(()=>{ perf.textContent=old; perf.style.color=''; perf.style.fontWeight=''; },1200);
      }catch(_){ const url=oc.toDataURL('image/png'); window.open(url,'_blank'); }
    });
  })();

  /* ===== exports ===== */
  function requireExportOk(){ if(saveWebpBtn.disabled){ alert('Ïô∏Î∂Ä(CDN) Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑûÏó¨ ÎÇ¥Î≥¥ÎÇ¥Í∏∞Í∞Ä Ï∞®Îã®Îê®.\nZIP/Ìè¥ÎçîÎ°ú Î∂àÎü¨Ïò§Í±∞ÎÇò ÎèôÏùº Ïò§Î¶¨ÏßÑÏúºÎ°ú ÌîÑÎ°ùÏãúÌïòÏÑ∏Ïöî.'); return false;} return true; }

  saveSelectedBtn.addEventListener('click', async ()=>{
    if(!requireExportOk()) return;
    const selected = [...(selectionState.selected || new Set())].sort((a,b)=>a-b);
    if (selected.length===0){ alert('ÏÑ†ÌÉùÎêú ÌîÑÎ†àÏûÑÏù¥ ÏóÜÏäµÎãàÎã§.'); return; }
    const s = __getExportScale();
    const oc=document.createElement('canvas'); oc.width=48*s*selected.length; oc.height=64*s;
    const g=oc.getContext('2d'); g.imageSmoothingEnabled=false;
    selected.forEach((i,k)=>{ const sx=(i%9)*48, sy=Math.floor(i/9)*64; g.drawImage(cvs, sx, sy, 48,64, 48*s*k, 0, 48*s, 64*s); });
    const blob=await encodeWebPFromCanvas(oc,{lossless:true,quality:1.0});
    const a=document.createElement('a'); a.download=`${fileBase()}-frames_${selected.join('_')}_${s}x.webp`; a.href=URL.createObjectURL(blob); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
  });

  exportFramesBtn.addEventListener('click', async ()=>{
    if(!requireExportOk()) return;
    const selected = [...(selectionState.selected || new Set())].sort((a,b)=>a-b);
    if (selected.length===0){ alert('ÏÑ†ÌÉùÎêú ÌîÑÎ†àÏûÑÏù¥ ÏóÜÏäµÎãàÎã§.'); return; }
    const s = __getExportScale(); const base=fileBase();
    for(let idx=0; idx<selected.length; idx++){
      const i=selected[idx]; const oc=document.createElement('canvas'); oc.width=48*s; oc.height=64*s;
      const g=oc.getContext('2d'); g.imageSmoothingEnabled=false;
      const sx=(i%9)*48, sy=Math.floor(i/9)*64; g.drawImage(cvs,sx,sy,48,64,0,0,48*s,64*s);
      const blob=await encodeWebPFromCanvas(oc,{lossless:true,quality:1.0});
      const a=document.createElement('a'); a.download=`${base}-frame-${i}_${s}x.webp`; a.href=URL.createObjectURL(blob); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
      if(idx<selected.length-1) await new Promise(r=>setTimeout(r,70));
    }
  });

  saveAllZipBtn.addEventListener('click', async ()=>{
    if(!requireExportOk()) return;
    if (!window.JSZip){ alert('JSZip not loaded'); return; }
    const zip=new JSZip(); const currentNumbers=fileBase(); const [faceNum,skinNum,hairNum,clothesNum]=currentNumbers.split(',');
    const s=__getExportScale(); const zipFileName=`frame_all_${faceNum}${skinNum}${hairNum}${clothesNum}_0~35_${s}x.zip`;
    for(let i=0;i<36;i++){
      const sx=(i%9)*48, sy=Math.floor(i/9)*64;
      const oc=document.createElement('canvas'); oc.width=48*s; oc.height=64*s;
      oc.getContext('2d').drawImage(cvs, sx, sy,48,64,0,0,48*s,64*s);
      const blob=await encodeWebPFromCanvas(oc,{lossless:true,quality:1.0});
      const b64=await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(blob); });
      zip.file(`frame_${faceNum}${skinNum}${hairNum}${clothesNum}_${i}.webp`, b64, {base64:true});
    }
    const cont=await zip.generateAsync({type:'blob'});
    const a=document.createElement('a'); a.download=zipFileName; a.href=URL.createObjectURL(cont); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
  });

  saveWebpBtn.addEventListener('click', async ()=>{
    if(!requireExportOk()) return;
    const s=__getExportScale();
    const oc=document.createElement('canvas'); oc.width=cvs.width*s; oc.height=cvs.height*s;
    const g=oc.getContext('2d'); g.imageSmoothingEnabled=false;
    g.drawImage(cvs,0,0,cvs.width,cvs.height,0,0,oc.width,oc.height);
    const blob=await encodeWebPFromCanvas(oc,{lossless:true,quality:1.0});
    const a=document.createElement('a'); a.download=`${fileBase()}_${s}x.webp`; a.href=URL.createObjectURL(blob); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
  });

  /* ===== CDN quick scan ===== */
  async function urlExists(url){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>resolve(true);
      img.onerror = ()=>resolve(false);
      img.src = url + (url.includes('?')?'&':'?') + 't=' + Date.now();
    });
  }
  async function scanCdnPart(part){
    // heuristic ranges ‚Äî tweak if needed
    const ranges = {
      face:   {start:-1, end:-300, step:-1},
      skin:   {start:-1, end:-120, step:-1},
      hair:   {start:-1, end:-1200, step:-1},
      clothes:{start:-1, end:-1200, step:-1},
      glass:  {start:-1, end:-400, step:-1}
    };
    const R = ranges[part];
    let added=0, miss=0, stopAt=40;
    for(let n=R.start; (R.step<0? n>=R.end : n<=R.end); n+=R.step){
      const u = `${ZEP_BASE}/${part}/${n}.png`;
      const p = `${ZEP_BASE}/${part}/${n}_preview.png`;
      const ok = await urlExists(u);
      if(!ok){ miss++; if(miss>=stopAt) break; continue; } else { miss=0; }
      const cell = store.assets[part].get(n) || {url:null,previewUrl:null,name:`${part}_${n}.png`};
      cell.url = u; cell.previewUrl = (await urlExists(p))?p:u;
      store.assets[part].set(n, cell); added++;
      if(added%10===0) { perf.textContent=`scan ${part}: +${added}`; }
    }
    perf.textContent = `scan ${part}: +${added}`;
    if(store.pick[part]==null){ const keys=[...store.assets[part].keys()].sort((a,b)=>a-b); store.pick[part]=keys[0]??null; }
    refreshExportLock(); // likely locks exports due to external
    selectPart(part); await drawSheet();
  }
  cdnScanBtn.addEventListener('click', ()=>{ scanCdnPart('face'); });
  scanGoBtn.addEventListener('click', ()=>{ scanCdnPart(scanPartSel.value); });

  /* ===== layout / zoom / splitter ===== */
  bgColor.addEventListener('input', e=>{ canvasWrap.style.backgroundImage='none'; canvasWrap.style.backgroundColor=e.target.value; });
  toggleLeft.addEventListener('click', ()=>{ const collapsed=bodyGrid.classList.toggle('collapsed'); leftPanel.classList.toggle('collapsed',collapsed); toggleLeft.textContent=collapsed?'‚ñ∂':'‚óÄ'; });
  let scale=1; function applyZoom(){ cvs.style.width=(432*scale)+'px'; cvs.style.height=(256*scale)+'px'; }
  function fit(){ const wrap=canvasWrap; const s=Math.min((wrap.clientWidth-16)/432,(wrap.clientHeight-16)/256); scale=Math.max(0.25,Math.min(s,8)); applyZoom(); }
  function zoomIn(){ scale=Math.min(8,scale*1.25); applyZoom(); }
  function zoomOut(){ scale=Math.max(0.25,scale/1.25); applyZoom(); }
  zoomInBtn.addEventListener('click', zoomIn); zoomFitBtn.addEventListener('click', fit);
  window.addEventListener('resize', fit); fit();
  const split=document.getElementById('split'); let dragging=false, sx=0, startW=0;
  split.addEventListener('mousedown',(e)=>{ dragging=true; sx=e.clientX; startW=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--rightW'))||560; document.body.style.userSelect='none'; });
  window.addEventListener('mousemove',(e)=>{ if(!dragging) return; const dx=sx-e.clientX; let w=startW+dx; w=Math.max(340,Math.min(980,w)); document.documentElement.style.setProperty('--rightW', w+'px'); });
  window.addEventListener('mouseup',()=>{ dragging=false; document.body.style.userSelect=''; });

  // perf ticker
  let rafId=null, last=performance.now(); function tick(t){ const dt=Math.round(t-last); perf.textContent = dt>50?`Busy ${dt}ms`:`Idle`; last=t; rafId=requestAnimationFrame(tick); } rafId=requestAnimationFrame(tick);

  /* ===== init ===== */
  document.addEventListener('DOMContentLoaded', async ()=>{
    highlightColor(); selectPart('face'); await drawSheet();
    const sel=document.getElementById('exportScale'); if(sel){ const saved=+localStorage.getItem('exportScale')||1; if([1,2,3,4,6,8,16].includes(saved)) sel.value=String(saved); sel.addEventListener('change',()=>localStorage.setItem('exportScale',sel.value)); }
  });
})();
</script>
</body>
</html>
