<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avatar Customizer — ZIP Fallback + Favicon</title>

  <!-- Inline favicon to avoid 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%23000"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="34" fill="%23fff">A</text></svg>' />

  <!-- Base path setup -->
  <script>
    (function () {
      const isLocal = location.protocol === "file:" || location.hostname === "localhost" || location.hostname === "";
      const repoBase = location.hostname.endsWith("github.io")
        ? ("/" + (location.pathname.split("/")[1] || "") + "/")
        : "./";
      const base = document.createElement("base");
      base.href = isLocal ? "./" : repoBase;
      document.head.appendChild(base);
      window.__IS_LOCAL__ = isLocal;
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Helvetica, Arial; margin: 0; }
    .bar { display:flex; gap:8px; align-items:center; padding:12px; border-bottom:1px solid #e5e7eb; position:sticky; top:0; background:#fff; z-index:10;}
    .log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; padding:12px;}
    button { padding:8px 12px; border-radius:8px; border:1px solid #cbd5e1; background:#f8fafc; cursor:pointer;}
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    .hidden { display:none; }
    .err { color: #b91c1c; }
    .ok { color: #065f46; }
  </style>
</head>
<body>
  <div class="bar">
    <strong>ZIP 로더</strong>
    <button id="pickZipBtn" class="hidden">ZIP 선택(로컬/웹)</button>
    <button id="reloadBtn">재시도</button>
    <span id="status"></span>
  </div>
  <div class="log" id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const pickBtn = document.getElementById('pickZipBtn');
    const reloadBtn = document.getElementById('reloadBtn');

    const RAW_CANDIDATE = "https://raw.githubusercontent.com/Mgpixelart/avatar-customize-v1/main/assets/current.zip";
    const RELEASE_CANDIDATE = ""; // ex) https://github.com/Mgpixelart/avatar-customize-v1/releases/download/v1.0.0/current.zip

    function log(msg) { logEl.textContent += msg + "\n"; }
    function setStatus(msg, cls) { statusEl.className = cls || ""; statusEl.textContent = msg; }

    async function fetchZip(url) {
      log("[ZIP] fetching: " + url);
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status + " for " + url);
      const blob = await res.blob();
      return await JSZip.loadAsync(blob);
    }

    async function pickLocalZip() {
      if (!window.showOpenFilePicker) {
        throw new Error("showOpenFilePicker 미지원. 브라우저 변경 또는 간단 서버 사용 권장.");
      }
      const [handle] = await window.showOpenFilePicker({
        types: [{ description: "ZIP file", accept: { "application/zip": [".zip"] } }],
        excludeAcceptAllOption: false, multiple: false,
      });
      const file = await handle.getFile();
      const buf = await file.arrayBuffer();
      return await JSZip.loadAsync(buf);
    }

    async function tryLoadZip() {
      setStatus("ZIP 로딩 중…");

      // 1) 우선 로컬 모드면 파일 선택부터
      if (window.__IS_LOCAL__) {
        pickBtn.classList.remove("hidden");
        try {
          const zip = await pickLocalZip();
          setStatus("로컬 ZIP 로드 성공", "ok");
          log("entries: " + Object.keys(zip.files).length);
          return zip;
        } catch (e) {
          setStatus("로컬 ZIP 선택 실패", "err");
          log("[local picker] " + e.message);
          throw e;
        }
      }

      // 2) 웹 모드: 순차 시도
      const candidates = ["assets/current.zip", "current.zip"];
      if (RELEASE_CANDIDATE) candidates.push(RELEASE_CANDIDATE);
      candidates.push(RAW_CANDIDATE);

      let lastErr = null;
      for (const u of candidates) {
        try {
          const zip = await fetchZip(u);
          setStatus("ZIP 로드 성공: " + u, "ok");
          log("entries: " + Object.keys(zip.files).length);
          return zip;
        } catch (e) {
          lastErr = e;
          log("[fail] " + e.message);
        }
      }

      // 3) 모두 실패 → 파일 선택 버튼 노출(웹에서도)
      pickBtn.classList.remove("hidden");
      setStatus("모든 ZIP 시도 실패 — ZIP 직접 선택 가능", "err");
      throw lastErr || new Error("All ZIP fetch failed");
    }

    async function boot() {
      try {
        await tryLoadZip();
        log("boot ok");
      } catch (e) {
        log("All ZIP fetch failed. " + e);
      }
    }

    pickBtn.addEventListener("click", async () => {
      log("pickZip clicked");
      try {
        const zip = await pickLocalZip();
        setStatus("수동 ZIP 로드 성공", "ok");
        log("entries: " + Object.keys(zip.files).length);
      } catch (e) {
        setStatus("수동 ZIP 선택 실패", "err");
        log("[manual picker] " + e.message);
      }
    });

    reloadBtn.addEventListener("click", boot);

    // auto start
    boot();
  </script>
<script>
(function(){
  // Improved ZIP helpers injected
  async function __zip_fetch(url){
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status + " for " + url);
    const blob = await res.blob();
    return await JSZip.loadAsync(blob);
  }

  async function __zip_pick(){
    if (!window.showOpenFilePicker) {
      throw new Error("showOpenFilePicker 미지원. 브라우저 변경 또는 간단 서버 사용 권장.");
    }
    const [h] = await window.showOpenFilePicker({
      types: [{ description: "ZIP file", accept: { "application/zip": [".zip"] } }],
      excludeAcceptAllOption: false, multiple: false,
    });
    const file = await h.getFile();
    const buf = await file.arrayBuffer();
    return await JSZip.loadAsync(buf);
  }

  // Override existing functions if present
  window.fetchZip = async function(url){
    // Backward-compatible: keep signature, but use our fetch
    return __zip_fetch(url);
  };

  window.tryLoadZip = async function(){
    // If local file:// — prefer picker
    if (window.__IS_LOCAL__) {
      try { return await __zip_pick(); } catch(e) {}
    }
    // Candidates on web
    const candidates = [
      "assets/current.zip",
      "current.zip",
      // Releases URL (optional) — replace if you use Releases
      // "https://github.com/Mgpixelart/avatar-customize-v1/releases/download/v1.0.0/current.zip",
      // Always include RAW fallback
      "https://raw.githubusercontent.com/Mgpixelart/avatar-customize-v1/main/assets/current.zip"
    ];
    let lastErr = null;
    for (const u of candidates) {
      try { return await __zip_fetch(u); }
      catch(e){ lastErr = e; }
    }
    // All failed → allow manual pick (even on web)
    try { return await __zip_pick(); } catch(e) {}
    throw lastErr || new Error("All ZIP fetch failed");
  };

  // If boot exists and expects tryLoadZip, we keep behavior.
  // We do not override boot to preserve app logic.

})();
</script>

</body>
</html>
